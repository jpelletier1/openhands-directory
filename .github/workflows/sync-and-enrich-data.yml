name: Sync and Enrich Data

on:
  workflow_dispatch:
    # Allow manual triggering
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  sync-and-enrich:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install openhands-sdk pydantic pyyaml

    - name: Install GitHub CLI
      run: |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh

    - name: Authenticate GitHub CLI
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "$GITHUB_TOKEN" | gh auth login --with-token

    - name: Clone microagents directory using GitHub CLI
      run: |
        # Create the skills directory if it doesn't exist
        mkdir -p public/examples/skills
        
        # Remove existing files to ensure clean sync
        rm -rf public/examples/skills/*
        
        # Use GitHub CLI to download the microagents directory
        gh repo clone OpenHands/OpenHands temp_openhands --depth 1
        
        # Copy microagents content to skills directory
        if [ -d "temp_openhands/microagents" ]; then
          cp -r temp_openhands/microagents/* public/examples/skills/
          echo "Successfully cloned microagents to public/examples/skills"
        else
          echo "Warning: microagents directory not found in OpenHands repository"
          ls -la temp_openhands/
        fi
        
        # Clean up temporary directory
        rm -rf temp_openhands

    - name: Create sync and enrich script
      run: |
        cat > sync_and_enrich.py << 'EOF'
        import os
        import json
        import re
        import yaml
        from pathlib import Path
        from pydantic import SecretStr
        from openhands.sdk import LLM



        def generate_title_and_description(file_path, content):
            """Use OpenHands SDK to generate title and description"""
            try:
                # Configure LLM
                api_key = os.getenv("LLM_API_KEY")
                if not api_key:
                    print("Warning: LLM_API_KEY not set, using placeholder values")
                    filename = os.path.basename(file_path)
                    return {
                        'title': filename.replace('.md', '').replace('_', ' ').title()[:25],
                        'description': "Automated task execution microagent"[:20]
                    }
                
                model = os.getenv("LLM_MODEL", "openhands/claude-sonnet-4-5-20250929")
                base_url = os.getenv("LLM_BASE_URL")
                
                llm = LLM(
                    model=model,
                    api_key=SecretStr(api_key),
                    base_url=base_url if base_url else None,
                    usage_id="sync_and_enrich",
                )
                
                # Prepare the prompt for title (5 words or less)
                title_prompt = f"Generate a concise title for this microagent file. The title must be 5 words or less.\n\nFile name: {os.path.basename(file_path)}\nContent preview: {content[:500]}...\n\nRespond with only the title, no additional text."
                
                # Generate title
                title_response = llm.completion(
                    messages=[{"role": "user", "content": title_prompt}]
                )
                
                title_text = title_response.choices[0].message.content if hasattr(title_response, 'choices') else str(title_response)
                title = title_text.strip().strip('"').strip("'")
                
                # Ensure title is 5 words or less
                title_words = title.split()
                if len(title_words) > 5:
                    title = ' '.join(title_words[:5])
                
                # Prepare the prompt for description (20 words or less)
                desc_prompt = f"Generate a brief description for this microagent. The description must be 20 words or less.\n\nFile name: {os.path.basename(file_path)}\nContent preview: {content[:500]}...\n\nRespond with only the description, no additional text."
                
                # Generate description
                desc_response = llm.completion(
                    messages=[{"role": "user", "content": desc_prompt}]
                )
                
                desc_text = desc_response.choices[0].message.content if hasattr(desc_response, 'choices') else str(desc_response)
                description = desc_text.strip().strip('"').strip("'")
                
                # Ensure description is 20 words or less
                desc_words = description.split()
                if len(desc_words) > 20:
                    description = ' '.join(desc_words[:20])
                
                return {
                    'title': title,
                    'description': description
                }
                
            except Exception as e:
                print(f"Error generating title/description with LLM: {e}")
                import traceback
                traceback.print_exc()
                filename = os.path.basename(file_path)
                return {
                    'title': filename.replace('.md', '').replace('_', ' ').title()[:25],
                    'description': "Automated task execution microagent"[:20]
                }

        def sync_examples_data():
            """Sync examples-data.json with files in public/examples/skills"""
            examples_data_path = "public/examples-data.json"
            skills_dir = "public/examples/skills"
            
            # Load existing examples data
            try:
                with open(examples_data_path, 'r', encoding='utf-8') as f:
                    examples_data = json.load(f)
            except FileNotFoundError:
                examples_data = []
            except Exception as e:
                print(f"Error loading examples-data.json: {e}")
                examples_data = []
            
            # Get current skills files
            skills_files = set()
            if os.path.exists(skills_dir):
                for root, dirs, files in os.walk(skills_dir):
                    for file in files:
                        if file.endswith(('.md', '.py', '.js', '.ts', '.txt')):
                            rel_path = os.path.relpath(os.path.join(root, file), skills_dir)
                            # Extract skill name from directory structure
                            skill_name = os.path.dirname(rel_path) if os.path.dirname(rel_path) else 'general'
                            filename = os.path.splitext(file)[0]
                            file_id = f"{skill_name}-{filename}"
                            skills_files.add(file_id)
            
            # Get current skills entries in examples data
            skills_entries = {item['id']: item for item in examples_data if item.get('category') == 'skills'}
            
            # Remove entries that no longer exist in files
            examples_data = [item for item in examples_data if not (item.get('category') == 'skills' and item['id'] not in skills_files)]
            
            # Add new entries for files not in examples data
            for file_id in skills_files:
                if file_id not in skills_entries:
                    # Find the actual file path
                    file_path = None
                    for root, dirs, files in os.walk(skills_dir):
                        for file in files:
                            if file.endswith(('.md', '.py', '.js', '.ts', '.txt')):
                                rel_path = os.path.relpath(os.path.join(root, file), skills_dir)
                                skill_name = os.path.dirname(rel_path) if os.path.dirname(rel_path) else 'general'
                                filename = os.path.splitext(file)[0]
                                current_id = f"{skill_name}-{filename}"
                                if current_id == file_id:
                                    file_path = os.path.join(root, file)
                                    break
                        if file_path:
                            break
                    
                    if file_path:
                        print(f"Processing new file: {file_path}")
                        
                        # Read file content
                        try:
                            with open(file_path, 'r', encoding='utf-8') as f:
                                content = f.read()
                        except Exception as e:
                            print(f"Error reading {file_path}: {e}")
                            continue
                        
                        # Generate title and description using SDK
                        generated = generate_title_and_description(file_path, content)
                        
                        # Create new entry (no code field - will be loaded from file)
                        new_entry = {
                            'id': file_id,
                            'title': generated['title'],
                            'author': 'OpenHands Team',
                            'category': 'skills',
                            'description': generated['description'],
                            'file': os.path.basename(file_path)
                        }
                        
                        examples_data.append(new_entry)
                        print(f"Added new entry: {file_id}")
            
            # Save updated examples data
            try:
                with open(examples_data_path, 'w', encoding='utf-8') as f:
                    json.dump(examples_data, f, indent=2, ensure_ascii=False)
                print(f"Updated {examples_data_path}")
            except Exception as e:
                print(f"Error saving examples-data.json: {e}")

        def main():
            print("Starting sync and enrich process...")
            sync_examples_data()
            print("Sync and enrich process completed!")

        if __name__ == "__main__":
            main()
        EOF

    - name: Run sync and enrich process
      env:
        LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        LLM_MODEL: ${{ secrets.LLM_MODEL || 'openhands/claude-sonnet-4-5-20250929' }}
        LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
      run: |
        python sync_and_enrich.py

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Commit and push changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Sync and enrich microagents from OpenHands/OpenHands

          - Synced microagents directory to public/examples/skills using GitHub CLI
          - Updated examples-data.json to sync with current skills files
          - Generated titles (5 words max) and descriptions (20 words max) using OpenHands SDK
          - Removed obsolete entries and added new entries for skills category
          
          Co-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          
          git push origin main
          echo "Changes pushed successfully"
        fi

    - name: Summary
      run: |
        echo "Workflow completed successfully!"
        echo "- Used GitHub CLI to clone microagents directory to public/examples/skills"
        echo "- Synced examples-data.json with current skills files"
        echo "- Generated titles and descriptions using OpenHands SDK"
        echo "- Committed and pushed changes to repository"